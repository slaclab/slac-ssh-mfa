<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
</head>
<body>
    <h1>{{ username }}</h1>
    <p>{{ message }}</p>

    <p>To create a new private key, please use the following command on the computer that you wish to use it on:</p>

    <pre><code>

# setup the local directories for the keypairs
mkdir -p {{ prefix_path }}
chmod 700 {{ prefix_path }}

# generate a new keypair
ssh-keygen -t ed25519 -f {{ prefix_path }}/temp-key -C "{{ username }}"
# determine the SHA256 fingerprint and move the key to the correct location
fingerprint=$(ssh-keygen -lf {{ prefix_path }}/temp-key | cut -f2 -d' ' | sed 's|[/+]|.|g')
mv {{ prefix_path }}/temp-key {{ prefix_path }}/${fingerprint}
# perhaps just delete this?
mv {{ prefix_path }}/temp-key.pub {{ prefix_path }}/${fingerprint}.pub

# configure your local ssh configuration to include the s3df config
grep -q "Include {{ prefix_path }}/s3df.conf" ~/.ssh/config || sed -i '1s@^@Include {{ prefix_path }}/s3df.conf\n\n@' >> ~/.ssh/config

# add s3df ssh dropin config
cat > {{ prefix_path }}/s3df.conf << EOF
Host sdfssh001 sdfssh001.slac.stanford.edu sdfssh001.sdf.slac.stanford.edu sdfssh002 sdfssh002.slac.stanford.edu sdfssh002.sdf.slac.stanford.edu s3dflogin-mfa.slac.stanford.edu
$(find {{ prefix_path }} -type f -name 'SHA256:*' -print0 | xargs -0 -n1 echo '    IdentityFile ')
EOF


# determine the public key for your newly minted keypair - this must be uploaded to our servers so that you can use this keypair to access S3DF
ssh-keygen -e -f {{ prefix_path }}/${fingerprint}


    </code></pre>

    <p>The output from the previous set of commands provides the ssh public key that we can use to identify you on our servers when you use this private key to ssh into our systems.</p>
    <p>Please enter this public key into the following form so that we may register it in our systems.</p>

    <form action="/upload/{{ username }}" }}">
        <textarea name="public_key" rows="10" cols="50" placeholder="Paste your public key here..."></textarea><br>
        <input type="submit" value="Submit">
    </form>



</html>
