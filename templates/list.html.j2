<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
</head>
<body>
    <h1>{{ username }}</h1>
    
    <p>Generate new keypair <button onclick="window.location.href='/generate/{{ username }}'" class="create">Generate</button></p>

    <table id="mykeys">
    <tr>
        <th>finger print</th>
        <th>created_at</th>
        <th>source_ip</th>
        <th>valid_until</th>
        <th>expires_at</th>
        <th>action</th>
    </tr>
{% for key in keys %}
    <tr data-fingerprint="{{ key['finger_print'] }}">

    <td>
{{ key['finger_print'] }} 
    </td>
    <td>
{{ key['created_at'] }} 
    </td>
    <td>
{{ key['source_ip'] }}
    </td>
    <td>
{{ key['valid_until'] }} 
    </td>
    <td>
{{ key['expires_at'] }} 
    </td>

    <td>
    <button class="refresh">Refresh</button>
    <button class="destroy">Destroy</button>
    </td>




    </tr>
{% endfor %}
    </table>

<script type="text/javascript">
    const username = "{{ username }}";

    const fpoperation = function(url, method) {
        fetch(url, { "method": method })
        .then(response => {
            if (response.ok) {
              return response.text();
            } else {
              throw new Error(`Server error: ${response.status}`);
            }
        })
        .then(data => {
            console.log("Reloading the page");
            window.location.reload();
        })
        .catch(error => {
            alert('Fetch error:', error);
        })
    }
    
    document.querySelectorAll(".refresh").forEach((el) => el.addEventListener("click", (ev) => {
        const fingerprint = ev.currentTarget.closest("tr").getAttribute("data-fingerprint");
        fpoperation(`../refresh/${username}/${fingerprint}`, "PATCH");
    }))
    document.querySelectorAll(".destroy").forEach((el) => el.addEventListener("click", (ev) => {
        const fingerprint = ev.currentTarget.closest("tr").getAttribute("data-fingerprint");
        fpoperation(`../destroy/${username}/${fingerprint}`, "DELETE");
    }))
</script>    
</html>